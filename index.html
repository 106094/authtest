<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Borrow / Return / Inventory</title>
    <style>
    :root { --primary:#4f46e5; --bg:#0b0c10; --card:#ffffff; }
    body { margin:0; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f5f7fb; }
    .shell { max-width:680px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:20px; }
    .card * {
      box-sizing: border-box;
    }
    /* Keep inputs fully inside, not overflowing */
    .card input[type="text"],
    .card input[type="datetime-local"],
    .card textarea,
    .card select {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
    h1,h2{ margin:0 0 8px }
    .muted{ color:#6b7280; margin-top:0 }
    .row { display:flex; gap:12px; }
    .col { flex:1 }
    .btn { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; }
    .btn.primary { background:var(--primary); color:#fff; }
    .btn.ghost { background:#eef2ff; color:#3730a3; }
    .btn.full { width:100% }
    .grid { display:grid; gap:12px }
    label { display:block; font-size:13px; color:#374151; margin-bottom:6px; }
    input[type=text] { width:100%; padding:12px 44px 12px 12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    input[readonly] { background:#f9fafb; }
    .field {
      position: relative;
      display: flex;
      align-items: center;
    }
    .field input {
      flex: 1;
    }
    .field .icon-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }
    .icon-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); border:0; background:transparent; padding:6px; cursor:pointer; }
    .prop-row { display:flex; gap:8px; align-items:center }
    .prop-row .remove { border:0; background:transparent; color:#ef4444; font-size:20px; cursor:pointer; }
    .divider { height:1px; background:#e5e7eb; margin:8px 0 4px }
    .toast { position:fixed; left:50%; bottom:28px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none }
    /* Scanner modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal > .sheet { background:#000; width:min(720px, 96vw); border-radius:16px; overflow:hidden; }
    #video { width:100%; background:#000; aspect-ratio:3/4; object-fit:cover }
    .modal .bar { display:flex; gap:8px; padding:10px; background:#0f172a; color:#fff; align-items:center; justify-content:space-between }
    .modal .bar .btn { border-radius:8px; padding:8px 10px; }
    .center-screen {
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:20px;
      }
  </style>
</head>
<body>

<!-- =============== LOGIN SCREEN =============== -->
<div id="loginScreen">
  <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="card" style="text-align:center; max-width:400px; width:100%;">
      <h1>Borrow / Return / Inventory</h1>
      <p class="muted">Please sign in with your Google account</p>

      <div style="margin:30px 0;">
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="signin_with"
             data-shape="rectangular">
        </div>
      </div>

      <p style="font-size:13px; color:#6b7280;">Only authorized emails can access this tool</p>
    </div>
  </div>
</div>
  
<!-- =============== BLOCKED SCREEN =============== -->
<div id="blockedScreen"
     style="display:none; min-height:100vh; align-items:center; justify-content:center; padding:20px;">
  <div class="card" style="color:#dc2626;">
    <h2>Not Authorized</h2>
    <p>Your account does not have edit access to the log spreadsheet.<br>
       Contact the administrator to be added to the authorized Google Group.</p>
    <button class="btn ghost" onclick="location.reload()">Try again</button>
  </div>
</div>

<!-- =============== MAIN APP =============== -->
<div id="app" style="display:none;">
  <div class="shell">

    <!-- ZXing Barcode Scanner (module) -->
        <script type="module">
          import {
            BrowserMultiFormatReader,
            BrowserCodeReader
          } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";
        
          import {
            DecodeHintType,
            BarcodeFormat
          } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.0/+esm";

      const hints = new Map();
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [
        BarcodeFormat.QR_CODE,
        BarcodeFormat.CODE_128,
        BarcodeFormat.CODE_39,
        BarcodeFormat.EAN_13,
        BarcodeFormat.EAN_8
      ]);
      hints.set(DecodeHintType.TRY_HARDER, true);

      // ---- expose global ----
      window.ZXingBrowser = {
        BrowserMultiFormatReader,
        BrowserCodeReader,
        DecodeHintType,
        BarcodeFormat,
        hints
      };

      console.log("ZXing 0.1.5 + hints loaded");
    </script>
  
  <div class="shell">
    <div class="card" id="home">
      <!-- Header with title left + logout right -->
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
        <div>
          <h1>Borrow / Return / Inventory</h1>
          <p class="muted">Hello, <span id="userName" style="font-weight:600;"></span>!</p>
          <p class="muted">Choose an action</p>
        </div>
    
        <button class="btn ghost" onclick="logout()">
          Log out
        </button>
      </div>
    
      <!-- Action buttons -->
      <div class="row" style="margin-top:12px; gap:12px;">
        <button class="btn primary full" onclick="openForm('Borrow')">Borrow</button>
        <button class="btn ghost full" onclick="openForm('Return')">Return</button>
        <button class="btn ghost full" onclick="openForm('Inventory')">Inventory</button>
      </div>
    </div>
    
    <div class="card" id="formCard" style="display:none; margin-top:16px">
      <h2 id="formTitle">Form</h2>
      <div class="grid" style="margin-top:12px">
        <div><label>Date</label><input id="date" type="text" readonly></div>
        <div><label>Name</label></div>
        <div class="field">
          <input id="name" type="text" placeholder="Scan or type a name">
           <button class="icon-btn" aria-label="Scan name" onclick="openScanner('name')">ðŸ“·</button>
        </div>
        <div>
          <div class="row" style="align-items:center; justify-content:space-between">
            <label style="margin:0">Property ID(s)</label>
            <button class="btn ghost" onclick="addPropertyRow()">+ Add line</button>
          </div>
          <div id="props" class="grid" style="margin-top:8px"></div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn full" onclick="goHome()">Back</button>
          <button class="btn primary full" onclick="submitForm()">Confirm / Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div class="modal" id="scannerModal" role="dialog">
      <div class="sheet">
        <video id="video" autoplay playsinline muted></video>
        <div class="bar">
          <div>Point camera at a QR codeâ€¦</div>
          <div>
            <button class="btn" onclick="toggleTorch()">Torch</button>
            <button class="btn" onclick="closeScanner()">Close</button>
          </div>
        </div>
      </div>
    </div>

  <div class="toast" id="toast"></div>
</div>

<!-- Google Sign-In SDK -->
<script src="https://accounts.google.com/gsi/client" async defer onload="handleClientLoad()"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
// ================== CONFIG ==================          
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxzwLaLKmP0ixib-GxiaKOvT8l_-0ZeIeJXOWyhktqEqaROAc_QeVKjTWclgFL-gWweA/exec';   
const SHEET_ID = '1AQ4cvZ_SjbIkW-ZwJz2QbB_67Sepo4RUUtlkyNGsutE';  // â† your spreadsheet ID
let tokenClient;
let currentUser = null;

function showApp(user) {
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('userName').textContent = user.name || user.email.split('@')[0];
}

function showBlocked() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('blockedScreen').style.display = 'flex';
}

function logout() {
  const token = localStorage.getItem('sheetsToken');
  if (token) google.accounts.oauth2.revoke(token);
  localStorage.clear();
  location.reload();
}

// Step 1: Runs when Google Identity Services loads
function handleClientLoad() {
  const saved = localStorage.getItem('inventoryAppUser');
  const savedToken = localStorage.getItem('sheetsToken');

  if (saved && savedToken) {
    showApp(JSON.parse(saved));
    return;
  }

  // Render Google Sign-In button
  google.accounts.id.renderButton(document.getElementById('buttonDiv'), {
    theme: 'outline', size: 'large', text: 'signin_with'
  });

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: '941275028852-6d7m0cbgpa67vvhrsspgcn0a81m03hc9.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    callback: async (resp) => {
      if (resp.error || !resp.access_token) {
        showBlocked();
        return;
      }

      const payload = JSON.parse(atob(resp.credential.split('.')[1]));
      const email = payload.email;
      const name = payload.name || payload.given_name || email.split('@')[0];

      // STEP 1: Try to write login record to access_log
      const loginRow = [[new Date().toISOString(), email, name, 'login-attempt']];

      try {
        const logResponse = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/access_log!A1:append?valueInputOption=RAW`,
          {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${resp.access_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ values: loginRow })
          }
        );

        if (logResponse.ok) {
          // SUCCESS â†’ user is authorized!
          localStorage.setItem('inventoryAppUser', JSON.stringify(payload));
          localStorage.setItem('sheetsToken', resp.access_token);
          showApp(payload);
        } else {
          // FAILED â†’ not authorized
          const err = await logResponse.json();
          console.log('Access denied:', err);
          showBlocked();
        }
      } catch (e) {
        console.error('Login log failed:', e);
        showBlocked();
      }
    },
  });

  // Trigger login when user clicks the button
  document.getElementById('buttonDiv').onclick = () => tokenClient.requestAccessToken();
}

/** ====== STATE ====== */
let mode = 'Borrow';
let currentScanTargetId = null;
let codeReader = null;
let currentDeviceId = null;
let torchOn = false;
let currentInputEl = null;
/** ====== UTILS ====== */
function fmtDate(d=new Date()){
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function toast(msg, ms=2000){
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display='block';
  clearTimeout(el._t); el._t = setTimeout(()=> el.style.display='none', ms);
}
function goHome(){
  stopScanner();
  document.getElementById('formCard').style.display='none';
  document.getElementById('home').style.display='block';
}

/** ====== HOME -> FORM ====== */
function openForm(selected){
  mode = selected;
  document.getElementById('home').style.display='none';
  document.getElementById('formCard').style.display='block';
  document.getElementById('formTitle').textContent = `${mode} Form`;
  document.getElementById('date').value = fmtDate();
  document.getElementById('name').value = '';
  const wrap = document.getElementById('props');
  wrap.innerHTML = '';
  addPropertyRow(); // start with one
}

/** ====== PROPERTY ROWS ====== */
function updateRemoveButtons() {
  const rows = document.querySelectorAll('#props .prop-row');
  rows.forEach((row) => {
    const btn = row.querySelector('.remove');
    if (!btn) return;
    btn.style.display = rows.length > 1 ? 'inline-block' : 'none';
  });
}

function addPropertyRow(value=''){
  const wrap = document.getElementById('props');
  const idx = wrap.children.length;
  const row = document.createElement('div');
  row.className = 'prop-row';
  row.innerHTML = `
    <div class="field col">
      <input type="text" placeholder="Property ID" value="${value.replaceAll('"','&quot;')}" oninput="maybeAutogrow(this)">
      <button class="icon-btn" aria-label="Scan Property" onclick="openScanner(null, this.previousElementSibling)">ðŸ“·</button>
    </div>
    <button class="remove" title="Remove" onclick="removeRow(this)">âœ•</button>
  `;
  wrap.appendChild(row);
  maybeAutogrow(row.querySelector('input'));
  // Auto-add a new empty line when last line gets non-empty
  const input = row.querySelector('input');
  input.addEventListener('input', ()=>{
    const isLast = row === wrap.lastElementChild;
    if (isLast && input.value.trim()!=='') addPropertyRow();
     updateRemoveButtons(); 
  }, {once:false});
   updateRemoveButtons(); 
}

function maybeAutogrow(input){
  // noop placeholder; could auto-resize if needed
}

function openScannerForSibling(btn){
  const input = btn.parentElement.querySelector('input');
  input && openScanner(null, input);
}

function removeRow(btn){
  const wrap = document.getElementById('props');
  if (wrap.children.length <= 1) { toast('Keep at least one line'); return; }
  const row = btn.closest('.prop-row');
  row && wrap.removeChild(row);
   updateRemoveButtons(); 
}

async function toggleTorch(){
  try{
    const stream = document.getElementById('video').srcObject;
    const track = stream?.getVideoTracks?.()[0];
    if (!track) return;
    const caps = track.getCapabilities?.();
    if (!caps || !caps.torch) { toast('Torch not supported'); return; }
    torchOn = !torchOn;
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
  }catch(e){ toast('Torch failed'); }
}

function stopScanner(){
  try{
    codeReader && codeReader.reset();
  }catch{} finally{
    codeReader = null;
    torchOn = false;
  }
}
  
function showApp(user) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  const displayName = user.name || user.email.split('@')[0];
  document.getElementById('userName').textContent = displayName;
}
  
function closeScanner(){
  document.getElementById('scannerModal').style.display='none';
  stopScanner();
}

/** ====== SUBMIT ====== */
async function submitForm(){
  const date = document.getElementById('date').value.trim();
  const name = document.getElementById('name').value.trim();
  const allInputs = Array.from(
    document.querySelectorAll('#props .prop-row input')
  );
  const ids = allInputs.map(i => i.value.trim()).filter(Boolean);
  // Validate Name
  if (!name.trim()) {
    toast('Name cannot be empty');
    return;
  }
  if (ids.length === 0) {
    toast('Enter at least one Property ID');
    return;
  }
   
 const payload = { mode, date, name, propertyIds: ids };

 // Must have at least one non-empty property ID
 if (ids.length === 0) {
   toast('Enter at least one Property ID');
   return;
 }
  // NOTE: Apps Script often redirects (302) and lacks CORS headers.
  // Use no-cors fire-and-forget; we assume success if fetch doesn't throw.
  try{
    await fetch(SCRIPT_URL, {
      method:'POST',
      mode:'no-cors', // avoids CORS preflight; can't read response
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
    });
    toast(`Submitted ${ids.length} item(s)`);
    // Return to home after a short delay
    setTimeout(()=> goHome(), 400);
  }catch(e){
    toast('Submit failed: ' + e);
  }
}

/** ====== BOOT ====== */
if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
  document.body.innerHTML = '<div class="shell"><div class="card"><h2>HTTPS required</h2><p>Camera access needs HTTPS. Please host this page on HTTPS (GitHub Pages / Netlify) or run locally at http://localhost.</p></div></div>';
}
/** ====== SCANNER ====== */
async function openScanner(targetId=null, directInputEl=null) {
  if (!window.ZXingBrowser) { alert("ZXingBrowser not loaded yet"); return; }
  const { BrowserMultiFormatReader, BrowserCodeReader, hints } = window.ZXingBrowser;
  codeReader = new BrowserMultiFormatReader(hints);
  currentInputEl = directInputEl || (targetId ? document.getElementById(targetId) : null);

  document.getElementById('scannerModal').style.display='flex';

  const video = document.getElementById('video');
  video.setAttribute('playsinline', 'true');
  video.setAttribute('autoplay', 'true');
  video.muted = true;

  const cb = (result, err) => {
    if (!result) return;
    const text = result.getText();
    if (currentInputEl) {
      currentInputEl.value = text;
      currentInputEl.dispatchEvent(new Event('input', {bubbles:true}));
    }
    currentInputEl = null;
    closeScanner();
    toast('Scanned');
  };

  try {
    // 1) Ask browser for a decent resolution from the back camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width:  { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    video.srcObject = stream;
    await new Promise(r => {
      video.onloadedmetadata = () => {
        video.play().catch(()=>{});
        r();
      };
    });

    // 2) Let ZXing decode continuously from this video element
    await codeReader.decodeFromVideoElement(video, cb);
  } catch (e) {
    toast(`Camera error: ${e.name || 'Error'} â€” ${e.message || e}`);
  }
} 
</script>
</body>
</html>
