<!-- ============================================= -->
<!--  GOOGLE SIGN-IN + AUTHORIZATION (embed version) -->
<!-- ============================================= -->
<div id="loginScreen" style="text-align:center; padding:40px 20px;">
  <div class="card" style="display:inline-block; padding:32px 40px;">
    <h2 style="margin:0 0 16px">Borrow / Return / Inventory</h2>
    <p class="muted">Please sign in with your Google account</p>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="rectangular" style="margin:20px auto;"></div>
    <p style="font-size:13px; color:#6b7280;">Only authorized emails can access this tool</p>
  </div>
</div>

<div id="blockedScreen" style="display:none; text-align:center; padding:60px 20px; color:#dc2626;">
  <h2>Sorry</h2>
  <p>Your email is not on the authorized list.<br>Contact the admin to be added.</p>
</div>

<!-- Your entire existing app content goes here (unchanged) -->
<div id="app" style="display:none;">
  <!-- ←←← PUT ALL YOUR ORIGINAL HTML FROM <body> HERE ↓ ↓ ↓ -->
  .... (all your current cards, forms, scanner modal, etc.)
  <!-- ←←← END OF YOUR ORIGINAL CONTENT -->
</div>

<!-- Google Platform + One-tap library -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// ==================== CONFIGURATION ====================
  const SHEET_ID        = '1AQ4cvZ_SjbIkW-ZwJz2QbB_67Sepo4RUUtlkyNGsutE'; 
  const CLIENT_ID       = 'YOUR_G941275028852-6d7m0cbgpa67vvhrsspgcn0a81m03hc9.apps.googleusercontent.comOOGLE_CLIENT_ID_HERE';
  const SHEET_Name = 'authnames'
  const RANGE   = 'A:A';        // change sheet name if needed
// =====================================================

function parseCsvToEmails(csvText) {
  return csvText
    .split('\n')
    .flatMap(line => line.split(','))
    .map(e => e.replace(/"/g, '').trim().toLowerCase())
    .filter(Boolean);
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
}

function showBlocked() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('blockedScreen').style.display = 'block';
}

// Check if user was already authorized in this browser
window.addEventListener('load', () => {
  const saved = localStorage.getItem('inventoryAppUser');
  if (saved) {
    showApp();
    return; // skip Google button completely
  }

  // Otherwise initialize Google Sign-In
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false
  });

  google.accounts.id.renderButton(
    document.querySelector('.g_id_signin'),
    { theme: "outline", size: "large" }
  );
});

async function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  const email = payload.email.toLowerCase();

  // Fetch allowed list from your Google Sheet (public link)
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&range=${RANGE}`;
  try {
    const csv = await fetch(url).then(r => r.text());
    const allowedEmails = parseCsvToEmails(csv);

    if (allowedEmails.includes(email)) {
      localStorage.setItem('inventoryAppUser', JSON.stringify(payload)); // remember forever
      showApp();
    } else {
      showBlocked();
    }
  } catch (e) {
    alert('Error checking authorization. Check internet connection or Sheet sharing settings.');
  }
}

// Optional: Add a logout button somewhere in your app
function logout() {
  localStorage.removeItem('inventoryAppUser');
  location.reload();
}
// Example logout button you can place anywhere inside #app:
// <button class="btn ghost" onclick="logout()" style="margin:20px 0;">Log out</button>
</script>
