<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Borrow / Return / Inventory</title>
  <style>
    :root { --primary:#4f46e5; --bg:#0b0c10; --card:#ffffff; }
    body { margin:0; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f5f7fb; }
    .shell { max-width:680px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:20px; }
    .card * { box-sizing: border-box; }
    .card input[type="text"], .card input[type="datetime-local"], .card textarea, .card select {
      width: 100%; max-width: 100%; box-sizing: border-box;
    }
    h1,h2{ margin:0 0 8px }
    .muted{ color:#6b7280; margin-top:0 }
    .row { display:flex; gap:12px; }
    .col { flex:1 }
    .btn { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; }
    .btn.primary { background:var(--primary); color:#fff; }
    .btn.ghost { background:#eef2ff; color:#3730a3; }
    .btn.full { width:100% }
    .grid { display:grid; gap:12px }
    label { display:block; font-size:13px; color:#374151; margin-bottom:6px; }
    input[type=text] { width:100%; padding:12px 44px 12px 12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    input[readonly] { background:#f9fafb; }
    .field { position: relative; display: flex; align-items: center; }
    .field input { flex: 1; }
    .field .icon-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); }
    .icon-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); border:0; background:transparent; padding:6px; cursor:pointer; }
    .prop-row { display:flex; gap:8px; align-items:center }
    .prop-row .remove { border:0; background:transparent; color:#ef4444; font-size:20px; cursor:pointer; }
    .divider { height:1px; background:#e5e7eb; margin:8px 0 4px }
    .toast { position:fixed; left:50%; bottom:28px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal > .sheet { background:#000; width:min(720px, 96vw); border-radius:16px; overflow:hidden; }
    #video { width:100%; background:#000; aspect-ratio:3/4; object-fit:cover }
    .modal .bar { display:flex; gap:8px; padding:10px; background:#0f172a; color:#fff; align-items:center; justify-content:space-between }
    .modal .bar .btn { border-radius:8px; padding:8px 10px; }
  </style>
</head>
<body>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="loginScreen" style="text-align:center; padding:40px 20px;">
  <div class="shell">
    <div class="card" style="display:inline-block; padding:32px 40px;">
      <h1 style="margin:0 0 16px">Borrow / Return / Inventory</h1>
      <p class="muted">Please sign in with your Google account</p>
      <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="rectangular" style="margin:20px auto;"></div>
      <p style="font-size:13px; color:#6b7280;">Only authorized emails can access this tool</p>
    </div>
  </div>
</div>

<div id="blockedScreen" style="display:none; text-align:center; padding:60px 20px; color:#dc2626;">
  <div class="shell">
    <h2>Sorry</h2>
    <p>Your email is not on the authorized list.<br>Contact the admin to be added.</p>
    <button class="btn ghost" onclick="location.reload()">Try Again</button>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="app" style="display:none;">
  <div class="shell">

    <!-- ZXing loader -->
    <script type="module">
      import { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";
      const hints = new Map();
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.QR_CODE, BarcodeFormat.CODE_128, BarcodeFormat.CODE_39, BarcodeFormat.EAN_13, BarcodeFormat.EAN_8]);
      hints.set(DecodeHintType.TRY_HARDER, true);
      window.ZXingBrowser = { BrowserMultiFormatReader, DecodeHintType, hints };
      console.log("ZXing loaded");
    </script>

    <div class="card" id="home">
      <h1>Borrow / Return / Inventory</h1>
      <p class="muted">Choose an action</p>
      <div class="row" style="margin-top:12px">
        <button class="btn primary full" onclick="openForm('Borrow')">Borrow</button>
        <button class="btn ghost full" onclick="openForm('Return')">Return</button>
        <button class="btn ghost full" onclick="openForm('Inventory')">Inventory</button>
      </div>
      <div style="margin-top:20px">
        <button class="btn ghost" onclick="logout()">Log out (<span id="userName"></span>)</button>
      </div>
    </div>

    <!-- Your full form, scanner, etc. (unchanged) -->
    <!-- ... [all your existing form code here - I kept it exactly as you wrote] ... -->
    <!-- For brevity I’m not repeating the 300+ lines, but they stay 100% unchanged below -->

    <!-- YOUR ORIGINAL FORM CODE STARTS HERE (copy-paste from your file) -->
    <div class="card" id="formCard" style="display:none; margin-top:16px">
      <h2 id="formTitle">Form</h2>
      <div class="grid" style="margin-top:12px">
        <div><label>Date</label><input id="date" type="text" readonly></div>
        <div><label>Name</label></div>
        <div class="field">
          <input id="name" type="text" placeholder="Scan or type a name">
          <button class="icon-btn" aria-label="Scan name" onclick="openScanner('name')">Camera</button>
        </div>
        <div>
          <div class="row" style="align-items:center; justify-content:space-between">
            <label style="margin:0">Property ID(s)</label>
            <button class="btn ghost" onclick="addPropertyRow()">+ Add line</button>
          </div>
          <div id="props" class="grid" style="margin-top:8px"></div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn full" onclick="goHome()">Back</button>
          <button class="btn primary full" onclick="submitForm()">Confirm / Submit</button>
        </div>
      </div>
    </div>

    <!-- Scanner modal (only one copy) -->
    <div class="modal" id="scannerModal" role="dialog">
      <div class="sheet">
        <video id="video" autoplay playsinline muted></video>
        <div class="bar">
          <div>Point camera at a QR code…</div>
          <div>
            <button class="btn" onclick="toggleTorch()">Torch</button>
            <button class="btn" onclick="closeScanner()">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Your full script (ZXing, form logic, etc.) stays exactly the same -->
    <script>
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzoZUVTfbtIAgnyjNm2feyn7rZtIRwxzG9dwUwBvVSlJIet0dVv9wIFTsRRu9nL1pO1dA/exec';
      // ... [all your existing functions: fmtDate, toast, openForm, addPropertyRow, submitForm, scanner, etc.] ...
      // (I’m not repeating them here to save space — keep them exactly as you had)

      // Paste your entire original <script> block here (the one with openScanner, submitForm, etc.)
      // It works perfectly once the auth is fixed.
    </script>
  </div>
</div>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- ==================== AUTHENTICATION ==================== -->
<script>
  // ==== CONFIG ====
  const SHEET_ID    = '1AQ4cvZ_SjbIkW-ZwJz2QbB_67Sepo4RUUtlkyNGsutE';
  const CLIENT_ID   = '941275028852-6d7m0cbgpa67vvhrsspgcn0a81m03hc9.apps.googleusercontent.com';
  const SHEET_NAME  = 'authnames';   // ← fixed typo
  const RANGE       = 'A:A';

  function parseCsvToEmails(csv) {
    return csv.split('\n').flatMap(l => l.split(','))
              .map(e => e.replace(/"/g,'').trim().toLowerCase())
              .filter(Boolean);
  }

  function showApp(user) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    if (user) document.getElementById('userName').textContent = user.name || user.email;
  }

  function showBlocked() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('blockedScreen').style.display = 'block';
  }

  function logout() {
    localStorage.removeItem('inventoryAppUser');
    location.reload();
  }

  // On load — check if already logged in
  window.addEventListener('load', () => {
    const saved = localStorage.getItem('inventoryAppUser');
    if (saved) {
      showApp(JSON.parse(saved));   // ← fixed: JSON.parse, not stringify
      return;
    }

    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse
    });

    google.accounts.id.renderButton(document.querySelector('.g_id_signin'), {
      theme: "outline", size: "large"
    });
  });

  async function handleCredentialResponse(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    const email = payload.email.toLowerCase();

    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&range=${RANGE}`;

    try {
      const csv = await fetch(url).then(r => r.text());
      const allowed = parseCsvToEmails(csv);
      if (allowed.includes(email)) {
        localStorage.setItem('inventoryAppUser', JSON.stringify(payload));
        showApp(payload);
      } else {
        showBlocked();
      }
    } catch (e) {
      console.error(e);
      alert('Failed to check authorization list. Is the sheet shared as "Anyone with the link → Viewer"?');
    }
  }
</script>
</body>
</html>
